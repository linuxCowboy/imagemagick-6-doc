<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="generator" content=
  "HTML Tidy for HTML5 for Linux version 5.6.0">
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../../../../html/www/css/magick.css">
  <title>Affine Matrix Transforms -- IM v6 Examples</title>
  <link rel="icon" href="../../img_www/favicon.ico" type=
  "image/x-icon">
  <link rel="shortcut icon" href="../../img_www/favicon.ico" type=
  "image/x-icon">
  <link rel="canonical" href=
  "https://legacy.imagemagick.org/Usage/distorts/affine/">
  <!--[if gte IE 5.5000]><![if lt IE 7.0000]>
<script type="text/javascript" src="../../img_www/pngfix.js"></script>
<![endif]><![endif]-->
</head>
<body bgcolor="#B0C4DE">
  <h1>ImageMagick v6 Examples --<br>
  <img src="../../img_www/space.gif" width="50" height="1"> Affine
  Matrix Transforms</h1>
  <div align="justify">
    <dl>
      <dd><b>Index</b></dd>
      <dt>
        <a href="../../index.html"><img src=
        "../../img_www/granitesm_left.gif" border="0" width="15"
        height="15"> ImageMagick Examples Preface and Index</a><br>
      </dt>
      <dt>
        <a href="index.html#affine"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15"> Affine Matrix Transforms</a>
      </dt>
      <dt>
        <a href="index.html#affine_scale"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Affine Scaling</a>
      </dt>
      <dt>
        <a href="index.html#affine_flip"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Affine Flips and Flops</a>
      </dt>
      <dt>
        <a href="index.html#affine_shear"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Affine Shearing</a>
      </dt>
      <dt>
        <a href="index.html#affine_rot"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Affine Rotations</a>
      </dt>
      <dt>
        <a href="index.html#affine_pos"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Position of Affine Results</a>
      </dt>
      <dt>
        <a href="index.html#affine_trans"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Affine Translations</a>
      </dt>
      <dt>
        <a href="index.html#affine_repos"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Affine Result Re-Positioning</a>
      </dt>
      <dt>
        <a href="index.html#affine_compound"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Compound Affine Translations</a>
      </dt>
      <dt>
        <a href="index.html#affine_scripts"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Affine Helper Scripts</a>
      </dt>
      <dt>
        <a href="index.html#affine_other"><img src=
        "../../img_www/granitesm_right.gif" border="0" width="15"
        height="15">Other Affine Transform Methods</a>
      </dt>
      <dt><nobr><a href="index.html#affine_diy"><img src=
      "../../img_www/granitesm_right.gif" border="0" width="15"
      height="15">Affine Transform DIY</a> <font size=
      "-1">(internal details)</font></nobr></dt>
    </dl>The Affine Projection Matrix is not a simple distortion
    operator to understand. But it is very versatile and fast to
    distort an image using it. In this section we take a look at
    how the affine matrix works, both in ImageMagick and all other
    Image Processors. WARNING: See the first <img src=
    "../../img_www/warning.gif" width="28" height="28" align=
    "absmiddle"> message below.
    <hr>
    <!-- ---------------------------------------------------------------- -->
    <a name="affine" id="affine"></a>
    <h2>Affine Transformations</h2>The Affine Transformation is a
    general rotation, shear, scale, and translation distortion
    operator. That is it will modify an image to perform all four
    of the given distortions all at the same time. These are all
    'linear' distortions, by which I mean two straight parallel
    lines present in an image will remain straight and parallel. It
    is not a perspective or trapezoidal transformation, which while
    lines remain straight, they may not remain parallel. Confused.
    I'm not surprised. Both Affine and Perspective Transforms are
    such a general technique that it is difficult to understand. So
    I'll try to start slow with what you have seen, and advance to
    more difficult aspects as we go.<br>
    The "<a href=
    "../../../../html/www/command-line-options.html#affine"><code>-affine</code></a>"
    option is a setting that defines a set of 6 numbers which fully
    defines the way an image is to be distorted. The "<a href=
    "../../../../html/www/command-line-options.html#transform"><code>-transform</code></a>"
    operator then performs this distortion. You can in fact apply
    affine transformation in a number of simpler ways using the
    newer <a href="../index.html#distort">Generalised Distortion
    Operator</a> "<a href=
    "../../../../html/www/command-line-options.html#distort"><code>-distort</code></a>",
    but I will use the older "<a href=
    "../../../../html/www/command-line-options.html#affine"><code>-affine</code></a>"
    operator instead, as it has historically always been available
    in IM. The two options "<a href=
    "../../../../html/www/command-line-options.html#affine"><code>-affine</code></a>"
    and "<a href=
    "../../../../html/www/command-line-options.html#transform"><code>-transform</code></a>",
    are separated as the "<a href=
    "../../../../html/www/command-line-options.html#affine"><code>-affine</code></a>"
    setting is also use as a vector mapping for the "<a href=
    "../../../../html/www/command-line-options.html#draw"><code>-draw</code></a>"
    command (see <a href="../../draw/index.html#affine">Warp the
    Drawing Surface</a>). As such, be careful about mixing these
    options. The arguments are supplied as a single comma separated
    string...
    <pre>     -affine  sx,rx,ry,sy,tx,ty</pre>These 6 numbers
    actually form a mathematical 'matrix' that translates a
    position in the source image to a final position in the
    destination image, and is expressed in terms of a 'matrix'...
    <pre>                                          | sx  rx  0 |
        | x', y', 1 |  =  | x, y, 1 |  *  | ry  sy  0 |
                                          | tx  ty  1 |</pre>This
equates to the mathematical formula...
    <pre>   ( x', y' ) = ( x * sx + y * ry + tx,   x * rx + y * sy + ty  )</pre>This
    should be kept in mind, and we will re-visit it later. However
    for now just note that this is the real meaning of a Affine
    transformation. As a starting point, if you use a "<a href=
    "../../../../html/www/command-line-options.html#affine"><code>-affine</code></a>"
    matrix of '<code>1,0,0,1,0,0</code>', the above formula will
    become...
    <pre>   ( x', y' ) = ( x, y )</pre>In other words, it will make
    <b>no changes</b> to the image, and is the best point to start
    our exploration of Affine Transformations. Here we apply this
    transformation to our 'koala' image...
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr valign="top">
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,0,0,1,0,0 -transform +repage affine_null.png
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="affine_null.png"><img src="affine_null.png"
          align="middle" vspace="0" hspace="5" border="0" alt=
          "[IM Output]"></a>
        </td>
      </tr>
    </table><!-- <CODE EXECUTE ASSERT>
  [ `convert affine_null.png -shave 1x1 miff:- |\
       compare -metric PAE koala.gif - null: 2>&1 |\
         sed 's/ .*//'` -ne '0' ] &&  echo >&2 \
  "ASSERTION FAILURE: Affine did not reproduce the original image."
</CODE> -->
    As you see nothing changed. But there are a few things you
    should note about the above command. The options "<code>-matte
    -virtual-pixel Transparent</code>" while not very important in
    the above, will be very important later. they basically tell IM
    to add a alpha channel and make all pixels outside the input
    image transparent. See <a href=
    "../../misc/index.html#transparent">Transparent Virtual Pixel
    Setting</a> for more detail. Also the image has been slightly
    enlarged by 1 pixel on all sides which is is to ensure that any
    semi-transparency effects along the edges of the image are also
    preserved. I also used a "<code><a href=
    "../../../../html/www/command-line-options.html#repage">+repage</a></code>"
    operator to reset the images position after performing the
    affine transformation. This is important as raw affine
    transformations can not only change an images size, but also an
    images position. In many cases a negative position is created
    which often does not work well with images used on a web page.
    This use of "<code><a href=
    "../../../../html/www/command-line-options.html#repage">+repage</a></code>"
    with affine will be talked about in detail later, as a useful
    part of the output from the affine transformation. But for now
    we will use it to ignore any translation component in the
    result.
    <table border="0" cellspacing="0" cellpadding="0" width="90%"
    align="center">
      <tr valign="top">
        <td><img src="../../img_www/warning.gif" width="28" height=
        "28"><img src="../../img_www/space.gif" width="12" height=
        "16"></td>
        <td align="justify" width="100%"><font size="-1"><i>Before
        IM v6.4.2-8, the "<code><a href=
        "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
        and "<code><a href=
        "../../../../html/www/command-line-options.html#transform">-transform</a></code>"
        combination, used the affine subroutine that was defined in
        the "<a href=
        "../../../../html/www/command-line-options.html#draw"><code>-draw</code></a>"
        operator. This affine distortion routine works but causes
        sever <a href=
        "../../resize/index.html#aliasing">aliasing</a> effects in
        the resulting image.<br>
        <br>
        After IM v6.4.2-8 the "<code><a href=
        "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
        and "<code><a href=
        "../../../../html/www/command-line-options.html#transform">-transform</a></code>"
        combination uses the new <a href=
        "../index.html#affine_projection">General Distort, Affine
        Projection</a> method to do work, with the <a href=
        "../index.html#distort_bestfit">Best-Fit</a> option. this
        produces much better results when strong scaling is
        applied. But is also means the various other <a href=
        "../index.html#distort_options">Distort Options</a> can
        also be used.<br>
        <br>
        As a result of this change the "<code><a href=
        "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
        and "<code><a href=
        "../../../../html/www/command-line-options.html#transform">-transform</a></code>"
        options are obsolete, and users should directly use the
        equivalent "<code>+distort AffineProjection ...</code>"
        operator instead, with all its extra control settings and
        options.<br>
        <br></i></font></td>
      </tr>
    </table>Here is the same example again using the newer
    "<code><a href=
    "../../../../html/www/command-line-options.html#distort">+distort</a></code>"
    operator, and producing the exact same result.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr valign="top">
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          +distort AffineProjection 1,0,0,1,0,0  +repage affine_proj_null.png
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="affine_proj_null.png"><img src=
          "affine_proj_null.png" align="middle" vspace="0" hspace=
          "5" border="0" alt="[IM Output]"></a>
        </td>
      </tr>
    </table><!-- <CODE EXECUTE ASSERT>
  [ `convert affine_proj_null.png -shave 1x1 miff:- |\
       compare -metric PAE koala.gif - null: 2>&1 |\
         sed 's/ .*//'` -ne '0' ] &&  echo >&2 \
  "ASSERTION FAILURE: AffineProjection did not reproduce the original image."
</CODE> -->
    The rest of these example use the old method as they were
    written long before the new "<code><a href=
    "../../../../html/www/command-line-options.html#distort">+distort</a></code>"
    operator became available. <a name="affine_scale" id=
    "affine_scale"></a>
    <h3>Affine Scaling</h3>The two '<code>1</code>' values in the
    last examples, or the '<code>sx</code>' and '<code>sy</code>'
    arguments, are scaling factors, and modifying these will
    enlarge or shrink the image. The size of the resulting image
    will be adjusted accordingly, so as to hold the complete
    result.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1.5,0,0,1.5,0,0 -transform +repage affine_expand.png
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1.0,0,0,0.5,0,0    -transform +repage affine_shrink.png
</code></pre>
          </td>
        </tr>
      </table><a href="affine_expand.png"><img src=
      "affine_expand.png" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a> <a href=
      "affine_shrink.png"><img src="affine_shrink.png" align=
      "middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a>
    </div>Note that the image are scaled to produce a simular
    result as "<code><a href=
    "../../../../html/www/command-line-options.html#resize">-resize</a></code>",
    but are not limited to whole pixel boundaries. That is you can
    have semi-tranparent (fuzzy) partial pixels along the edges of
    the image. See <a href="../../resize/index.html#distort">Resize
    Distort/Affine</a> for more details. <a name="affine_flip" id=
    "affine_flip"></a>
    <h3>Affine Flips and Flops</h3>This may not seem exciting or
    interesting, but image scaling with a negative will also
    produce "<code><a href=
    "../../../../html/www/command-line-options.html#flip">-flip</a></code>"
    and "<code><a href=
    "../../../../html/www/command-line-options.html#flop">-flop</a></code>"
    style of image transforms.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,0,0,-1,0,0   -transform  +repage  affine_flip.png
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine -1,0,0,1,0,0   -transform  +repage  affine_flop.png
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine -1,0,0,-1,0,0  -transform  +repage  affine_180.png
</code></pre>
          </td>
        </tr>
      </table><a href="affine_flip.png"><img src="affine_flip.png"
      align="middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a> <a href="affine_flop.png"><img src=
      "affine_flop.png" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a> <a href=
      "affine_180.png"><img src="affine_180.png" align="middle"
      vspace="5" hspace="5" border="0" alt="[IM Output]"></a>
    </div><a name="affine_shear" id="affine_shear"></a>
    <h3>Affine Shearing</h3>The middle two zero arguments,
    '<code>rx</code>' and '<code>ry</code>', will shear the image
    in a similar way the "<code><a href=
    "../../../../html/www/command-line-options.html#shear">-shear</a></code>"
    operator does.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,.3,0,1,0,0   -transform  +repage  affine_shear_x.png
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,-.3,0,1,0,0  -transform  +repage  affine_shear-x.png
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,0,.3,1,0,0   -transform  +repage  affine_shear_y.png
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,.3,.3,1,0,0  -transform  +repage  affine_shear_xy.png
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,-.3,.3,1,0,0 -transform  +repage  affine_shear_rot.png
</code></pre>
          </td>
        </tr>
      </table><a href="affine_shear_x.png"><img src=
      "affine_shear_x.png" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a> <a href=
      "affine_shear-x.png"><img src="affine_shear-x.png" align=
      "middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a> <a href="affine_shear_y.png"><img src=
      "affine_shear_y.png" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a> <a href=
      "affine_shear_xy.png"><img src="affine_shear_xy.png" align=
      "middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a> <a href="affine_shear_rot.png"><img src=
      "affine_shear_rot.png" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a>
    </div>Note how this is different to the 'simpler' <a href=
    "../../warping/index.html#shear">Shear Operator</a>, in that
    both the X and the Y shears are applied together, rather than
    consecutively. This allows the affine version of shear (with
    some proportional scaling) to perform proper rotations of the
    image about the origin point. The actual value use for the
    shear, is also not an angle, though is related (see below).
    That is a shear value of '<code>1</code>' will result in a 45
    degree shear, while a value of '<code>.5</code>' is an
    approximate 30 degree shear. This gets more complex however if
    some scaling or both X and Y shears are also applied at the
    same time. <a name="affine_rot" id="affine_rot"></a>
    <h3>Affine Rotations</h3>You may have noticed in the last
    example above that you can rotate an image just by using
    shears. However when rotating an image by only using shears,
    the image will become larger. To fix this you also need to make
    the image slightly smaller by adjusting the scaling of the
    image. For example...
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr valign="top">
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine .9,-.1,.1,.9,0,0 -transform  +repage affine_rotate.png
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="affine_rotate.png"><img src="affine_rotate.png"
          align="middle" vspace="0" hspace="5" border="0" alt=
          "[IM Output]"></a>
        </td>
      </tr>
    </table>If you want to calculate the correct affine matrix to
    do proper unscaled rotation for any angle you can use the
    following formula...
    <div align="center">
      sx = cos(α); &nbsp;&nbsp; rx = sin(α)<br>
      ry = -sin(α); &nbsp;&nbsp; sy = cos(α)<br>
      where α is the angle to rotate in radians.
    </div>For example...
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="" script="">
  angle=-75;   radians=`perl -e "print $angle * atan2(1,1)/45"`
    sx=`perl -e "print cos( $radians )"`
    rx=`perl -e "print sin( $radians )"`
    ry=`perl -e "print -($rx)"`
    sy="$sx"
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine $sx,$rx,$ry,$sy,0,0 -transform  +repage  affine_rotate2.png
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="affine_rotate2.png"><img src=
          "affine_rotate2.png" align="middle" vspace="0" hspace="5"
          border="0" alt="[IM Output]"></a>
        </td>
      </tr>
    </table>To make this calculation easier I created a simple perl
    script, "<code><a href=
    "../../scripts/affine_rotate">affine_rotate</a></code>" to do
    these calculations for you.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  affine_rotate 25  &gt; affine_rotate.txt
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine `affine_rotate 25` -transform +repage  affine_rotate3.png
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td valign="top" rowspan="2">
          <a href="affine_rotate3.png"><img src=
          "affine_rotate3.png" align="middle" vspace="0" hspace="5"
          border="0" alt="[IM Output]"></a>
        </td>
      </tr>
      <tr>
        <td>
          <table border="0" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <a href="affine_rotate.txt"><img src=
                "affine_rotate.txt.gif" align="middle" vspace="0"
                hspace="0" border="0" alt="[IM Text]"></a>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>More on this <a href="index.html#affine_scripts">Affine
    Helper Script</a> later. <a name="affine_pos" id=
    "affine_pos"></a>
    <h3>Position of Affine Results</h3>You will have noticed the
    use of "<code><a href=
    "../../../../html/www/command-line-options.html#repage">+repage</a></code>"
    in just about all the above examples of using an affine
    transformation. This is because the transformed image is not
    always a acceptable value for displaying images on web pages.
    So lets have a look at the raw canvas information generated by
    some of the transformations we used above. Here I perform a
    affine flop, shear, and rotate of the example image and output
    the resulting images information, but I will not display the
    images produced as they are the same as the previous examples,
    just having some 'negative' offsets making them un-displayable
    directly on a web page.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="" out="affine_raw_info.txt">
  convert koala.gif  -affine -1,0,0,1,0,0   -transform  info:
  convert koala.gif  -affine 1,-.3,0,1,0,0  -transform  info:
  convert koala.gif  -affine .9,-.1,.1,.9   -transform  info:
</code></pre>
          </td>
        </tr>
      </table>
      <table border="0" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <a href="affine_raw_info.txt"><img src=
            "affine_raw_info.txt.gif" align="middle" vspace="0"
            hspace="0" border="0" alt="[IM Text]"></a>
          </td>
        </tr>
      </table>
    </div>First ignore the size of the virtual canvas generated by
    the transformation. This size is of little importance as it is
    not always possible for it to be a sensible value, though IM
    tries to make it sensible in most cases. What is important is
    that the the final position of the images in all the these
    cases have a negative value. This is the true location of the
    image after the "<code><a href=
    "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
    transformation has been performed, and shows the image being
    transformed around the 'origin' or top-left corner of the
    image. <a name="affine_viewport" id="affine_viewport"></a> If
    we use a little extra processing of the transformed into a
    '<a href="../../crop/index.html#crop_viewport">viewport
    image</a>', we can show how the image was positioned relative
    to the images original origin or 0,0 position of the original
    image.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          affine_null_view.gif
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine -1,0,0,1,0,0   -transform \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          affine_flop_view.gif
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,-.3,0,1,0,0  -transform \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          affine_shear_view.gif
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 0.1,-0.95,0.95,0.1   -transform \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          affine_rot_view.gif
</code></pre>
          </td>
        </tr>
      </table><a href="affine_null_view.gif"><img src=
      "affine_null_view.gif" width="160" height="160" align=
      "middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a> <img src="../../img_www/right.gif" width=
      "20" height="20" align="middle" alt="==&gt;"> <a href=
      "affine_flop_view.gif"><img src="affine_flop_view.gif" width=
      "160" height="160" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a> <a href=
      "affine_shear_view.gif"><img src="affine_shear_view.gif"
      width="160" height="160" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a> <a href=
      "affine_rot_view.gif"><img src="affine_rot_view.gif" width=
      "160" height="160" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a>
    </div>Yes the above is complex, but adds a lot if information
    about the resulting "<code><a href=
    "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
    transformation that is normally hard to see. First it adds a
    blue border around the actual image data result without
    effecting the virtual offset of the resulting image. This is
    then overlaid onto a viewport canvas, with the origin or 0,0
    point centered in the image. A red cross is draw at that point,
    to show how the image relates to the origin of the original
    image after being transformed. Notice how in all the above
    transformations, the actual image generate is given a negative
    offset. That is the position of the very top left corner of the
    blue box is either above or to the left of the origin. The
    Affine transform does this as all the transformations performed
    leave the images original origin (0,0 pixel) at the origin.
    That is this point does not move when an image is purely
    scaled, rotated, or sheared. The only time the images original
    origin (or 0,0) point changes is if you also give a translation
    component. This special handling of virtual canvas offsets by
    the "<code><a href=
    "../../../../html/www/command-line-options.html#transform">-transform</a></code>"
    operator is important so as to avoid loosing information about
    the results of the affine transformation. It also means that we
    can use that offset to set this images location correctly when
    it is combined with other images. <a name="affine_trans" id=
    "affine_trans"></a>
    <h3>Affine Translations</h3>As a pure translation of an image
    (using an integer offset), only moves an image to another
    location without distortion, the actual result of the
    "<code><a href=
    "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
    transformation, is that the images page offset on the virtual
    page or canvas is changed. However IM will still process each
    and every pixel in the image, even though there only a simple
    change in offset. For example this shows that the image has
    been move on the larger virtual canvas, so that the koala's
    nose (pixel <code>28,24</code>) is positioned at the origin
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="" out="koala_nose_info.txt">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine 1,0,0,1,-28,-24  -transform  -identify   koala_nose.png
</code></pre>
          </td>
        </tr>
      </table>
      <table border="0" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <a href="koala_nose_info.txt"><img src=
            "koala_nose_info.txt.gif" align="middle" vspace="0"
            hspace="0" border="0" alt="[IM Text]"></a>
          </td>
        </tr>
      </table>
    </div>As you can see from the identify output above, the image
    size was not changed, though the offset of the image was
    changed. Unfortunately I can not display the generated PNG
    image directly on this web page, as a negative offset can cause
    undefined and often disastrous effects to the web browser
    output. By taking a <a href=
    "index.html#affine_viewport">viewport</a> image of the result,
    I can remove that negative offset and show how the image was
    translated relative to the images virtual canvas.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala_nose.png -virtual-pixel Transparent \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          koala_nose_vp.gif
</code></pre>
          </td>
        </tr>
      </table><a href="affine_null_view.gif"><img src=
      "affine_null_view.gif" width="160" height="160" align=
      "middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a> <img src="../../img_www/right.gif" width=
      "20" height="20" align="middle" alt="==&gt;"> <a href=
      "koala_nose_vp.gif"><img src="koala_nose_vp.gif" width="160"
      height="160" align="middle" vspace="5" hspace="5" border="0"
      alt="[IM Output]"></a>
    </div>Note how the koala image itself was left unchanged. Only
    its offset on the virtual canvas was modified. However you
    should note that IM did still did the calculations and
    processing needed for each and every pixel in the final image.
    In other words the result of a pure translation is that the
    image offset changed, and that you can do more easily and
    directly using a "<code><a href=
    "../../../../html/www/command-line-options.html#repage">-repage</a></code>"
    operation with a '<code>!</code>' flag. Of course if your
    affine matrix does more than just translate the image, or
    translates the image a fraction of a pixel, then you are better
    off doing the translation as part of the "<code><a href=
    "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
    matrix transformation. Translation components is an important
    part of a general "<code><a href=
    "../../../../html/www/command-line-options.html#affine">-affine</a></code>"
    transformation, as it will allow you to rotate an image about
    any point on the image, or even outside the image being
    transformed. <a name="affine_repos" id="affine_repos"></a>
    <h3>Affine Result Re-Positioning</h3>
    <table border="0" cellspacing="0" cellpadding="0" width="90%"
    align="center">
      <tr valign="top">
        <td><img src="../../img_www/expert.gif" width="23" height=
        "26"><img src="../../img_www/space.gif" width="17" height=
        "16"></td>
        <td align="justify" width="100%"><font size="-1"><i>Note
        that negative offsets are ignored by GIF image format, and
        will be saved as a zero offset, instead. On the other hand
        while the PNG file format will save negative offsets, many
        web browsers and image programs will not handle that
        situation, producing unexpected results.</i></font></td>
      </tr>
    </table>It is because of this I have avoided displayed any
    affine image results that contain a negative offset. Of course
    you can use negative offsets in PNG images for later work,
    preserving the offset for later use. For example if you save a
    image with a negative value into a GIF format image the
    negative values are replace by zero. And while PNG images will
    correctly save a negative position, it may have undefined
    consequences when displayed on a web browser. For example some
    browsers have been known to generate extremely large canvases
    for small PNG images with a negative offset. Of course the JPEG
    image format just ignores any position and canvas information
    that may be present. So what can you do to correct the position
    of an image, so as to have a positive offset. That depends on
    what you are trying to do. After applying a affine
    transformation, you would then usually apply one of the
    following operations, to adjust the canvas and offset of the
    resulting image.
    <dl>
      <dt><b>Reset the image position with +repage</b></dt>
      <dd>If you just want the resulting image, and don't care
      about the offset produced by the transformation, you can use
      "<code><a href=
      "../../../../html/www/command-line-options.html#repage">+repage</a></code>"
      to reset the page information, just as we do in the examples
      above.</dd>
      <dt><b>Crop image to a new relative position</b></dt>
      <dd>
        Using a '<a href=
        "../../crop/index.html#crop_viewport">viewport crop</a>'
        you can reposition the image and look at it as if you are
        viewing it though a window or viewport, onto the virtual
        canvas. An example of this is given above in <a href=
        "index.html#affine_viewport">Position of Affine
        Results</a>.
      </dd>
      <dt><b>Post Re-position of the Image</b></dt>
      <dd>
        You can always just translate the position of the resulting
        image. This can be done by using an absolute
        "<code><a href="../../../../html/www/command-line-options.html#repage">-repage</a></code>",
        a relative "<code><a href=
        "../../../../html/www/command-line-options.html#repage">-repage</a></code>"
        (with a '<code>!</code>' option), or even by adding a
        <b>Affine Translation</b> component to the translation
        matrix, to adjust the final position of the image. For
        example here is a correct flip affine transform, so that it
        is positioned correctly (other than the need to
        "<code><a href=
        "../../../../html/www/command-line-options.html#shave">-shave</a></code>"
        the extra edge pixels that were added as a precaution.
        <table border="0" cellspacing="0" cellpadding="0" width=
        "100%">
          <tr valign="top">
            <td>
              <table border="1" cellspacing="0" cellpadding="5"
              width="100%" bgcolor="#CCCCCC">
                <tr>
                  <td>
                    <pre><code execute="">
  convert koala.gif  -affine 1,0,0,-1,0,75  -transform \
          -shave 1x1  affine_goodflip.gif
</code></pre>
                  </td>
                </tr>
              </table>
            </td>
            <td>
              <a href="affine_goodflip.gif"><img src=
              "affine_goodflip.gif" align="middle" vspace="0"
              hspace="5" border="1" alt="[IM Text]"></a>
            </td>
          </tr>
        </table>Note that the translation component of an affine
        transformation is performed <b>after</b> the rotation and
        scaling has been completed. This is what we will look at in
        the next section.
      </dd>
    </dl>These are only some of the possibilities, and basically
    depends on just what you want to do with the resulting image.
    All you really need to do is decide whether you need to keep
    the offsets of the transformation, or not. <a name=
    "affine_compound" id="affine_compound"></a>
    <h3>Compound Affine Translations</h3>It is important to know
    that all the non-translation affine matrix methods does not
    actually cause the 0,0 position of the image to move. The only
    time this point actually moves was when either the generated
    offset of the image was reset (generally using "<code><a href=
    "../../../../html/www/command-line-options.html#repage">+repage</a></code>")
    or you also translated the resulting image, as part of the
    affine matrix. However one of the most important uses of affine
    transformations is to rotate images about a specific point,
    rather than the origin. And it is here that things start
    getting much more difficult. By re-positioning the image before
    the affine transformation, you can position the point about
    which you want to rotate, at the origin. This point should not
    move under a non-translation affine transformation, so that
    point will still be at the origin after the rotation has been
    performed. You can then move the image back to its original
    position, or some other position, in a controlled way. For
    example, in the example above we translated the koala image so
    that its nose (pixel 28,24) was at the origin. Now lets rotate
    that image. and again display a <a href=
    "index.html#affine_viewport">viewport</a> image of it on the
    larger virtual canvas.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif  -repage -28-24 -matte -virtual-pixel Transparent \
          -affine .5,-.866,.866,.5,0,0 -transform  koala_nose_rot.png
  convert koala_nose_rot.png \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          koala_nose_rot_vp.gif
</code></pre>
          </td>
        </tr>
      </table><a href="koala_nose_vp.gif"><img src=
      "koala_nose_vp.gif" width="160" height="160" align="middle"
      vspace="5" hspace="5" border="0" alt="[IM Output]"></a>
      <img src="../../img_www/right.gif" width="20" height="20"
      align="middle" alt="==&gt;"> <a href=
      "koala_nose_rot_vp.gif"><img src="koala_nose_rot_vp.gif"
      width="160" height="160" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a>
    </div>Notice that the rotation was around the origin, which due
    to the page offset, is currently positioned on the koala's
    nose. Now if you translate the image back by the original
    translation, we will have rotated the image about its nose, but
    without the nose changing position. That is, to properly rotate
    an image about a specific point you will need to translate,
    rotate, and translate the image back again. The last two parts
    being easily performed simply a single matrix. Here is the
    complete process with the final translation also performed by
    the affine matrix. Study it carefully and you will see that the
    koalas nose did not move on the virtual canvas, relative to the
    origin (red cross).
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif -repage -28-24 -matte -virtual-pixel Transparent \
          -affine .5,-.866,.866,.5,28,24 -transform  koala_rot_nose.png
  convert koala_rot_nose.png \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          koala_rot_nose_vp.gif
</code></pre>
          </td>
        </tr>
      </table><a href="affine_null_view.gif"><img src=
      "affine_null_view.gif" width="160" height="160" align=
      "middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a> <img src="../../img_www/right.gif" width=
      "20" height="20" align="middle" alt="==&gt;"> <a href=
      "koala_rot_nose_vp.gif"><img src="koala_rot_nose_vp.gif"
      width="160" height="160" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a>
    </div>Now affine matrices can of course do all three
    operations, all at the same time, however calculating the
    affine matrix needed is not a trivial matter. The following is
    the exact same operation, but with the appropriate, all-in-one
    affine matrix.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine .5,-.866,.866,.5,-9.134,36.248 -transform  koala_complete.png
  convert koala_complete.png \
          -bordercolor blue -compose copy -border 1x1 -repage -1-1\! \
          -compose over -crop 160x160-80-80\! -background lightblue -flatten \
          -draw "fill red  path 'M 80,70 80,90  M 70,80 90,80'" \
          koala_complete_vp.gif
</code></pre>
          </td>
        </tr>
      </table><a href="affine_null_view.gif"><img src=
      "affine_null_view.gif" width="160" height="160" align=
      "middle" vspace="5" hspace="5" border="0" alt=
      "[IM Output]"></a> <img src="../../img_www/right.gif" width=
      "20" height="20" align="middle" alt="==&gt;"> <a href=
      "koala_complete_vp.gif"><img src="koala_complete_vp.gif"
      width="160" height="160" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Output]"></a>
    </div>Note the position of the koala's nose relative to the
    origin has not changed, even though the resulting image is now
    larger with a negative canvas offset. To finish off lets repeat
    it again, but crop the image back to the images original area,
    and flatten onto a white background.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine .5,-.866,.866,.5,-9.134,36.248 -transform \
          -crop 75x75+0+0\! -background white  -flatten   koala_rot_nose.gif
</code></pre>
          </td>
        </tr>
      </table><a href="../../images/koala.gif"><img src=
      "../../images/koala.gif" width="75" height="75" align=
      "middle" vspace="5" hspace="5" border="1" alt=
      "[IM Output]"></a> <img src="../../img_www/right.gif" width=
      "20" height="20" align="middle" alt="==&gt;"> <a href=
      "koala_rot_nose.gif"><img src="koala_rot_nose.gif" width="75"
      height="75" align="middle" vspace="5" hspace="5" border="1"
      alt="[IM Output]"></a>
    </div>A perfect rotate by 60 degrees about the koala's nose.
    <a name="affine_scripts" id="affine_scripts"></a>
    <h3>Affine Helper Scripts</h3>As you can see in the examples
    above figuring out the affine matrix needed for your transform
    is not always easy. In fact it can be very difficult and may
    require a deep understanding of how affine matrices, and matrix
    calculations are performed to achieve the desired result.
    Because of this and to help in the creation of these examples I
    have created a number of helper scripts to let you calculate
    the affine matrix you needed.
    <h4>affine_rotate</h4>The affine matrix in last example could
    be more simply calculated using the "<code><a href=
    "../../scripts/affine_distort">affine_distort</a></code>"
    script I introduced earlier. If you supply this script with a
    extra argument containing the point of rotation than it will
    calculate the correct affine matrix to do it. For example here
    we use the script to repeat the last example to rotate about
    the koala's nose, but using a larger angle.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine `affine_rotate -110 28,24` -transform \
          -crop 75x75+0+0\! -background white -flatten koala_affine_rotate.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="koala_affine_rotate.gif"><img src=
          "koala_affine_rotate.gif" width="75" height="75" align=
          "middle" vspace="5" hspace="5" border="1" alt=
          "[IM Output]"></a>
        </td>
      </tr>
    </table>If you supply a second coordinate pair, the point of
    rotation (first coordinate) will also be moved to the new
    position you give! For example lets put the koala's nose of the
    last example near the bottom of the image.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
          -affine `affine_rotate -110 28,24 28,72` -transform \
          -crop 75x75+0+0\! -background white -flatten koala_affine_rotate2.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="koala_affine_rotate2.gif"><img src=
          "koala_affine_rotate2.gif" width="75" height="75" align=
          "middle" vspace="5" hspace="5" border="1" alt=
          "[IM Output]"></a>
        </td>
      </tr>
    </table>That is you can take an image with a specific point,
    and rotate and re-position the image using that 'handle'.
    <table border="0" cellspacing="0" cellpadding="0" width="90%"
    align="center">
      <tr valign="top">
        <td><img src="../../img_www/reminder.gif" width="20"
        height="16"><img src="../../img_www/space.gif" width="20"
        height="16"></td>
        <td align="justify" width="100%"><font size="-1"><i>This
        can also be directly achieved much more efficiently and
        directly using the "<code><a href=
        "../../../../html/www/command-line-options.html#distort">+distort</a></code>"
        method '<code>SRT</code>'.</i></font></td>
      </tr>
    </table>
    <h4>affine_distort</h4>The script <code><a href=
    "../../scripts/affine_distort">affine_distort</a></code>" is a
    similar script, but will also allow you to scale or flip an
    image before it is rotated and translated to a new position.
    The argument order is a little different, making it a little
    harder to use, but it is much more versatile. For example lets
    repeat the last example, but also shrink the image, around the
    repositioned 'handle'.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
         -affine `affine_distort 28,24 .5,.5 -110 28,72` -transform \
         -crop 75x75+0+0\! -background white -flatten koala_affine_distort.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="koala_affine_distort.gif"><img src=
          "koala_affine_distort.gif" width="75" height="75" align=
          "middle" vspace="5" hspace="5" border="1" alt=
          "[IM Output]"></a>
        </td>
      </tr>
    </table>The script however will not do any shearing of the
    image, but that is rarely desired.
    <table border="0" cellspacing="0" cellpadding="0" width="90%"
    align="center">
      <tr valign="top">
        <td><img src="../../img_www/reminder.gif" width="20"
        height="16"><img src="../../img_www/space.gif" width="20"
        height="16"></td>
        <td align="justify" width="100%"><font size="-1"><i>Again
        the '<code>SRT</code>' distortion method can be used to do
        this much more efficiently.<br>
        <br>
        In actual fact the '<code>SRT</code>' method was directly
        developed from the "<code><a href=
        "../../scripts/affine_distort">affine_distort</a></code>"
        script into the <a href="../index.html#distort">Generalized
        Distort Operator</a>.<br>
        <br></i></font></td>
      </tr>
    </table>
    <h4>affine_transform</h4>A affine transformation can be fully
    defined by the how a triangle of three coordinates are
    translated. For example, here I define three coordinates, but
    then give the same three coordinates in a 'flipped'
    arrangement. The result is that the whole image is flipped.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert koala.gif -matte -virtual-pixel Transparent \
       -affine "`affine_transform  75,0 0,0 0,75   75,75 0,75 0,0`" -transform \
       -crop 75x75+0+0\! -background white -flatten koala_affine_transform.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="koala_affine_transform.gif"><img src=
          "koala_affine_transform.gif" width="75" height="75"
          align="middle" vspace="5" hspace="5" border="1" alt=
          "[IM Output]"></a>
        </td>
      </tr>
    </table>By giving the "<code><a href=
    "../../scripts/affine_transform">affine_transform</a></code>"
    script two sets of three coordinates, we can convert the
    movement of these points, into the correct affine mapping to
    transform the whole image to match that movement. Unlike the
    previous script this one can flip, scale and shear images,
    however it is not so useful for rotating images, as you can not
    give it a direct angle of rotation.
    <table border="0" cellspacing="0" cellpadding="0" width="90%"
    align="center">
      <tr valign="top">
        <td><img src="../../img_www/reminder.gif" width="20"
        height="16"><img src="../../img_www/space.gif" width="20"
        height="16"></td>
        <td align="justify" width="100%"><font size="-1"><i>This
        can also be directly achieved much more efficiently and
        directly using the 3 control point '<code><a href=
        "../index.html#affine">Affine</a></code>' distortion
        method.<br>
        <br>
        And just like before that distortion method was actually a
        direct development from that script into the <a href=
        "../index.html#distort">Generalized Distort Operator</a>.
        However since its implementtation, the coordinate entry has
        been reorder slightly differently. See <a href=
        "../index.html#control_points">Distortions Using Control
        Points</a>.<br>
        <br></i></font></td>
      </tr>
    </table><a name="affine_other" id="affine_other"></a>
    <h3>Other Affine Transform Methods</h3>As I explained at the
    start of the previous section, an affine matrix is a linear
    equation that maps a point on the original image to a new
    position on the destination image. That is given the affine
    matrix argument...
    <pre>     -affine  sx,rx,ry,sy,tx,ty</pre>Actually equates to
    the mathematical formula...
    <pre>   ( i, j ) = ( x * sx + y * ry + tx,   x * rx + y * sy + ty  )</pre>That
    is given a point, <code>x,y</code> on the starting image, that
    point is remapped to the position <code>i,j</code> on the
    destination image. Quite straight forward really. For example
    suppose we have this simple image of a stylized spaceship,
    drawn using various lines form one point to the next.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert -size 80x80 xc:skyblue -fill red -stroke black \
          -draw 'path "M 15,5 20,35 25,5 Z M 10,25 30,25" ' \
          spaceship.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="spaceship.gif"><img src="spaceship.gif" align=
          "middle" vspace="0" hspace="5" border="1" alt=
          "[IM Text]"></a>
        </td>
      </tr>
    </table>This is basically a very simple '<a href=
    "../../draw/index.html#mvg">vector graphic</a>', and has very
    well defined points on the original image. The by using a
    relatively simple affine matrix such as "<code>-affine
    '1,-1,1,1,15,55'</code>" we can map each of the coordinates for
    our space ship to a new position. For example lets do the
    affine calculations to the first drawn coordinate of the above
    spaceship.
    <table align="center">
      <tr>
        <td>
          <pre>      x,y  =  15,5
      i,j  =   x*sx + y*ry + tx,   x*rx + y*sy + ty
           =&gt; 15*1 + 5*1  + 15,   15*-1 + 5*1  + 55     =&gt; 35,45  </pre>
        </td>
      </tr>
    </table>That is the coordinate <code>15,5</code> will be mapped
    by the affine transform to position <code>35,45</code>. After
    converting each coordinate in out original vector image, we can
    now now redraw the space ship in its new transformed
    position...
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert -size 80x80 xc:skyblue -fill red -stroke black \
          -draw 'path "M 35,45 70,70 45,35 Z M 50,70 70,50" ' \
          spaceship_mapped.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="spaceship_mapped.gif"><img src=
          "spaceship_mapped.gif" align="middle" vspace="0" hspace=
          "5" border="1" alt="[IM Text]"></a>
        </td>
      </tr>
    </table>Actually IM can do this mapping of vector coordinates
    for you...
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="" script="">
  convert -size 80x80 xc:skyblue -fill red -stroke black \
          -draw 'affine 1,-1,1,1,15,55
                 path "M 15,5 20,35 25,5 z M 10,25 30,25" ' \
          spaceship_mapped_2.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="spaceship_mapped_2.gif"><img src=
          "spaceship_mapped_2.gif" align="middle" vspace="0"
          hspace="5" border="1" alt="[IM Text]"></a>
        </td>
      </tr>
    </table>As the above shows, a vector image can be transformed
    very simply by just mapping the coordinates of the various line
    segments and drawing the image in a new position. Not only that
    but it also automatically scaled the line widths as
    appropriate, which we forgot to do in the hand calculated
    example. See <a href="../../draw/index.html#affine">Affine
    Warping</a> for more information on using an affine matrix with
    drawn vector images. Now lets get IM transform the original
    raster image we originally created of the spaceship.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert spaceship.gif   -affine 1,-1,1,1,15,55 -transform \
          -crop 80x80+0+0\! -background skyblue -flatten \
          spaceship_transformed.gif
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="spaceship_transformed.gif"><img src=
          "spaceship_transformed.gif" align="middle" vspace="0"
          hspace="5" border="1" alt="[IM Text]"></a>
        </td>
      </tr>
    </table>As you can see the result is not nearly as clean
    looking as a vector image transformation, but then that is one
    of the major drawbacks of using raster images. However other
    than that, the result of the transformation is correct. What is
    not shown above, is what IM actually did internally to
    transform a raster image. Which is the subject of the next
    section. <a name="affine_diy" id="affine_diy"></a>
    <h3>Affine Transform DIY <font size="-1">(the internal
    details)</font></h3>This is what IM actually goes thru
    internally to do an affine transformation. First we need to
    figure out the where the transform is going to map the image,
    so a new image can be created with the right size and offset.
    Now due to the transformation this final location is most
    likely nowhere near the same position as the original source
    image. But it needs to be done so as to preserve all parts of
    the image during the transformation, while using the smallest
    image size posible to contain that result. To calculate the
    size and offset of the destination, we first use the affine
    transformation on each of the four corners of the source image,
    to find the size and location of the destination image. Now our
    test image has no 'virtual canvas offset', so the coordinates
    of the four corners are: quite simply <code>0,0</code>,
    <code>80,0</code>, <code>0,80</code>, and <code>80,80</code>.
    If our image did have a starting offset, then we would just add
    the virtual offset to the actual width and height of our image
    to calculate the actual location of the corners of the source
    image. Processing these coordinates using the affine mapping we
    get...
    <table align="center" cellpadding="0">
      <tr>
        <th><font size="-1">Source Corners</font></th>
        <th rowspan="5">&nbsp; <img src="../../img_www/right.gif"
        width="20" height="20" align="middle" alt="==&gt;">
        &nbsp;</th>
        <th><font size="-1">Transformed</font></th>
      </tr>
      <tr>
        <td align="center"><font size="-2">0,0</font></td>
        <td align="center"><font size="-2">15,55</font></td>
      </tr>
      <tr>
        <td align="center"><font size="-2">80,0</font></td>
        <td align="center"><font size="-2">95,-25</font></td>
      </tr>
      <tr>
        <td align="center"><font size="-2">0,80</font></td>
        <td align="center"><font size="-2">95,135</font></td>
      </tr>
      <tr>
        <td align="center"><font size="-2">80,80</font></td>
        <td align="center"><font size="-2">175,55</font></td>
      </tr>
    </table>Our destination image will thus need to be just large
    enough to hold each of these four corners, with the results
    rounded up or down to the nearest whole integer. The 'virtual
    offset' will be the two smallest <code>x</code> and
    <code>y</code> values or <code>+15-25</code>, while the width
    and height of the destination image needs to be
    <code>160x160</code>. Note that the size of the resultin
    virtual canvas is irrelevant, and can be left to IM or the user
    to determine, set, or ignore. In summary, our
    <code>80x80</code> image with a <code>+0+0</code> offset will
    map completely into a <code>160x160</code> image with a
    <code>+15-25</code> offset. So we now know where the image will
    be after the transform we need to map the pixels from the
    source to the destination image. This however is not straight
    forward, as it is explained in <a href=
    "../index.html#summary">Distortion Summary</a>. That is rather
    than mapping each individual source pixel to the destination,
    we lookup the color of each destination pixel in the source.
    However to do that we need to invert the affine transformation
    to map the destination to the source image. But reversing a
    matrix is not simple and involves some very heavy mathematics.
    Fortunately due to the nature of affine matrices, the inverse
    is also an affine matrix, and the mathematics becomes greatly
    simplified.
    <table border="0" cellspacing="0" cellpadding="0" width="90%"
    align="center">
      <tr valign="top">
        <td><img src="../../img_www/expert.gif" width="23" height=
        "26"><img src="../../img_www/space.gif" width="17" height=
        "16"></td>
        <td width="100%">
          <pre><font size=
          "-1"><i>From IM code "draw.c" here is a simple Affine Matrix Inverter</i>
  det = sx*sy - rx*ry;
  inverse_sx  =  sy/det;
  inverse_rx  = -rx/det;
  inverse_ry  = -ry/det;
  inverse_sy  =  sx/det;    # yes, the next bit uses the just calculated values
  inverse_tx  = -tx*inverse_sx - ty*inverse_ry;
  inverse_ty  = -tx*inverse_rx - ty*inverse_sy;</font></pre>
        </td>
      </tr>
    </table>As such the reverse of the affine matrix
    '<code>1,1,-1,1,15,55</code>' is
    '<code>0.5,0.5,-0.5,0.5,20,-35</code>'. Thus producing an
    "<a href=
    "../../../../html/www/command-line-options.html#fx"><code>-fx</code></a>"
    expression of...
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code do_not_execute="">
              xx = 0.5*i -0.5*j +20; \
              yy = 0.5*i +0.5*j -35; \
</code></pre>
          </td>
        </tr>
      </table>
    </div>However the <code>i,j</code> pixel location used by
    "<a href=
    "../../../../html/www/command-line-options.html#fx"><code>-fx</code></a>"
    does not take into account the virtual offset we previously
    calculated for the destination image, or any virtual offset
    that may be present in the source image. As such the FX
    variables <code>i,j</code> first needs to have the destination
    images offset added to them, then transformed, and the source
    images offset subtracted, to produce the source images
    <code>x,y</code> location. Here a complete DIY affine
    transformation. Note how the destination image is created
    separately to the source image, using the calculated size and
    offset needed. Also that the source image is now the second or
    '<code>v</code>' image in the FX expression for the pixel color
    lookup.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="" script="">
  convert spaceship.gif \
          -size 160x160 -page +15-25  xc:  +swap \
          -matte -virtual-pixel transparent -channel RGBA \
          -fx 'ii = i + 15;   jj = j - 25;
               xx = 0.5*ii -0.5*jj +20;
               yy = 0.5*ii +0.5*jj -35;
               xx = xx - 0;   yy = yy - 0;   v.p{xx,yy}' \
          spaceship_diy.png
</code></pre>
          </td>
        </tr>
      </table>
    </div>
    <table border="0" cellspacing="0" cellpadding="0" width="90%"
    align="center">
      <tr valign="top">
        <td><img src="../../img_www/reminder.gif" width="20"
        height="16"><img src="../../img_www/space.gif" width="20"
        height="16"></td>
        <td align="justify" width="100%"><font size="-1"><i>As the
        resulting image has a negative offset I needed to use the
        PNG format to preserve that offset, as well as the
        semi-transparent edge pixels. Also I have not shown the
        results of the above transform directly, as many browsers
        get confused by a PNG images containing a negative
        offset.</i></font></td>
      </tr>
    </table>As we can't directly display the results, here is the
    result if we do a standard <a href=
    "../../crop/index.html#crop_viewport">viewport crop</a> of the
    transformed image using just the area of our original image.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="">
  convert spaceship_diy.png \
          -crop 80x80+0+0\! -background none  -flatten \
          spaceship_diy_port.png
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="spaceship_diy_port.png"><img src=
          "spaceship_diy_port.png" align="middle" vspace="0"
          hspace="5" border="1" alt="[IM Text]"></a>
        </td>
      </tr>
    </table>And so you can see the total result of the
    transformation, here is a larger overview <a href=
    "../../crop/index.html#crop_viewport">viewport crop</a> of the
    virtual canvas surrounding our resulting image.
    <div align="center">
      <table border="1" cellspacing="0" cellpadding="5" width="80%"
      bgcolor="#CCCCCC">
        <tr>
          <td>
            <pre><code execute="">
  convert spaceship_diy.png \
          -compose copy -bordercolor blue -border 1x1 -repage -1-1\! \
          -compose over -crop 200x200-10-50\! -background none -flatten \
          -draw " fill none  stroke red path 'M 0,50 20,50 M 10,40 10,60' \
                 stroke green path 'M 9,49 9,130 90,130 90,49 Z'" \
          -trim +repage  spaceship_diy_view.gif
</code></pre>
          </td>
        </tr>
      </table><a href="spaceship_diy_view.gif"><img src=
      "spaceship_diy_view.gif" align="middle" vspace="5" hspace="5"
      border="0" alt="[IM Text]"></a>
    </div>To show the relative positions of the result, I added a
    blue border around the result, and a red cross marking the
    <code>0,0</code> origin of the virtual canvas. I also drew a
    green box around the location of the original source image
    before it was transformed. This box is typically the normal
    area in which a <a href=
    "../../crop/index.html#crop_viewport">viewport crop</a> is
    taken (see previous example directly using the builtin affine
    transformation), rather than the larger overview of the virtual
    canvas exampled here. As you can see none of the image data was
    lost by this transformation, including the images final size
    and location on a larger 'virtual canvas'. Actually both of the
    pre- and post- image offsets can be merged into the affine
    matrix translation component. The source image offset can be
    just directly subtracted, though the destination image
    component will need to be translated before it is added to the
    final affine matrix transformation expression.
    <pre>
       tx =  sx * dest_off.x + ry * dest_off.y + tx  - src_off.x
       ty =  rx * dest_off.x + sy * dest_off.y + ty  - src_off.y
</pre>In our case
    <pre>
       tx =  .5 * +15  -.5 * -25  +20 - 0   =&gt;  40
       ty =  .5 * +15  +.5 * -25  -35 - 0   =&gt; -40
</pre>The result is a simplified and more direct image to image
affine transformation, with the images virtual offsets included as
part of the transform, as well as a standard crop to original image
view.
    <table border="0" cellspacing="0" cellpadding="0" width="100%">
      <tr>
        <td width="100%" align="justify">
          <table border="1" cellspacing="0" cellpadding="5" width=
          "100%" bgcolor="#CCCCCC">
            <tr>
              <td>
                <pre><code execute="" script="">
  convert -size 160x160 -page +15-25  xc: +page  spaceship.gif \
          -matte -virtual-pixel transparent -channel RGBA \
          -fx 'xx = 0.5*i -0.5*j +40;
               yy = 0.5*i +0.5*j -40; v.p{xx,yy}' \
          spaceship_diy_2.png

  convert spaceship_diy_2.png \
          -crop 80x80+0+0\! -background none  -flatten \
          spaceship_diy_2_port.png
</code></pre>
              </td>
            </tr>
          </table>
        </td>
        <td>
          <a href="spaceship_diy_2_port.png"><img src=
          "spaceship_diy_2_port.png" align="middle" vspace="0"
          hspace="5" border="1" alt="[IM Text]"></a>
        </td>
      </tr>
    </table>
    <hr>
    <!-- ---------------------------------------------------------------- -->
    <address>
      Created: 1 July 2007 (from distortion page above)<br>
      Updated: 10 October 2009<br>
      Author: <a href=
      "http://www.ict.griffith.edu.au/anthony/anthony.html">Anthony
      Thyssen</a>, &lt;Anthony.Thyssen@gmail.com&gt;<br>
      Examples Generated with: <img src="version.gif" align=
      "absmiddle" alt="[version image]"><br>
      URL:
      <code>https://legacy.imagemagick.org/Usage/distorts/affine/</code>
    </address>
  </div>
</body>
</html>
